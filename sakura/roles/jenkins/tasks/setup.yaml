---
- name: Create directory for archive files
  file:
    # TODO: Parameterize
    path: /var/lib/machine-setups/roles/jenkins
    state: directory
  become: yes


- name: Fetch jenkins package
  get_url:
    # TODO: parameterize
    url: https://pkg.jenkins.io/debian/binary/jenkins_2.183_all.deb
    # url: https://pkg.jenkins.io/debian-stable/binary/jenkins_2.176.1_all.deb
    checksum: sha512:6d66b39a0b9f7f40b5436f7e609e62dcba75fe8111d6486b7d9dcb11d5d24f30ddd7181ed86f3ffa70dc767d3c948b36cfdf248ede0fb5b1f583d19e7666759b
    dest: /var/lib/machine-setups/roles/jenkins
  register: _fetch_result
  become: yes

- name: Install jenkins
  apt:
    deb: "{{ _fetch_result.dest }}"
    # when: _fetch_result is changed
  become: yes

- name: Add JAVA_ARGS
  # https://wiki.jenkins.io/display/JENKINS/Features+controlled+by+system+properties
  # Cannot use init groovy to set system properties
  # To get properties, jenkins.util.SystemProperties can be used
  # https://javadoc.jenkins.io/jenkins/util/SystemProperties.html
  blockinfile:
    path: /etc/default/jenkins
    marker: "# {mark} Managed by machine-setups/sakura"
    block: |
      JAVA_ARGS="$JAVA_ARGS {{ jenkins_java_args }}"
    insertafter: EOF
  become: yes

- name: Create custom init scripts directory
  file:
    path: "{{ jenkins_home }}/init.groovy.d"
    state: directory
    owner: jenkins
    group: jenkins
    recurse: yes
  become: yes

- name: Add Jenkins init hook scripts
  template:
    src: "{{ item }}.groovy.j2"
    dest: "{{ jenkins_home }}/init.groovy.d/{{ item }}.groovy"
    owner: jenkins
    group: jenkins
  with_items:
    # TODO: Add basic configurations
    # TODO: Add num to order script
    - basic-security
    - plugins
    - theme
    - authorize-project
  become: yes
  no_log: yes
  notify: JENKINS_SAFERESTART


- name: Start jenkins
  service:
    name: jenkins
  become: yes
