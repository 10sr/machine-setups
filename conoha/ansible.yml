---
- hosts: default
  vars:
    # Do not use these variables directly in roles!
    ubuntu_codename: trusty
    domain_name: 3ends.info
    # secret:
    #   # Overwritten by secret.yml
    #   ddns_mydns_password: ""
    #   ddns_f5_si_password: ""
  vars_files:
    # - ./secret.yml
    - ./vault/ansible_become_pass.yml
    - ./vault/icecast2_source_password.yml
    - ./vault/icecast2_admin_password.yml
    - ./vault/icecast2_relay_password.yml
    # - ./vault/minio_secret_key.yml
    - ./vault/nextcloud_mysql_root_password.yml
    - ./vault/nextcloud_mysql_password.yml
    - ./vault/bot_twitter_secret.yml
    - ./vault/bot_twitter_token_secret.yml
  roles:
    - role: hostname
      hostname: "{{ domain_name }}"

    # - role: firewalld
    #   firewalld_port_states:
    #     - port: 22/tcp
    #       state: enabled
    #     - port: 80/tcp
    #       state: enabled
    #     - port: 443/tcp
    #       state: enabled
    #     - port: 3389/tcp
    #       state: enabled

    # - role: data_dir
    #   data_dir_dirs:
    #     - mountpoint: /data
    #       filepath: /data.fs
    #       size_mb: 15000

    #- apt-upgrade

    # - role: ddns
    #   ddns_domain_name: 10sr.f5.si
    #   ddns_name: 10sr

    # TODO: Remove icecast2 specific configs
    - role: nginx
      nginx_main_server_names:
        - "{{ domain_name }}"
        - 10sr.f5.si
      nginx_main_root: /var/nginx/main
      # not used yet
      nginx_proxy_upstreams: []

    - role: icecast2
      icecast2_server_name: ic.{{ domain_name }}
      icecast2_server_port: 3389
      icecast2_letsencrypt_access_dir: /.well-known/acme-challenge
      icecast2_letsencrypt_webroot: /var/nginx/main
      icecast2_liquidsoap_sources:
        - name: the_back_horn
          playlist: "/var/icecast2/THE BACK HORN/all.m3u"
        - name: ring_all
          playlist: /var/icecast2/ring/all.m3u
        - name: lovelive_all
          playlist: /var/icecast2/lovelive/all.m3u
        - name: lovelive_best1
          playlist: /var/icecast2/lovelive/lovelive_best1/all.m3u
        - name: lovelive_best2
          playlist: /var/icecast2/lovelive/lovelive_best2/all.m3u
      icecase2_admin_password: "{{ icecast2_admin_password }}"
      icecase2_relay_password: "{{ icecast2_relay_password }}"
      icecase2_source_password: "{{ icecast2_source_password }}"

    - role: letsencrypt
      letsencrypt_domain_names:
        - "{{ domain_name }}"
        - ic.{{ domain_name }}
        #- d.{{ domain_name }}
      letsencrypt_webroot: /var/nginx/main
      letsencrypt_key_dir: /etc/letsencrypt/live/{{ domain_name }}
      letsencrypt_ssl_key_dir: /etc/letsencrypt/live/{{ domain_name }}
      letsencrypt_ssl_dhparam_path: /etc/ssl/private/dhparam.pem

    - role: nginx_ssl
      nginx_ssl_main_server_name: "{{ domain_name }}"
      nginx_ssl_main_root: /var/nginx/main
      nginx_ssl_proxy_upstreams:
        - path: /wiki
          port: 4567
        - path: /minio
          port: 9000
        - path: /10sr_bot
          port: 5000
        - path: /nextcloud
          port: 8880
          additional_directives:
            - "add_header Strict-Transport-Security \"max-age=15552000; includeSubDomains\" always"
            - "client_max_body_size 1024M"
            - "rewrite /nextcloud/(.*) /$1 break"
        - path: /zabbix
          port: 8008

    - role: icecast2_ssl
      icecast2_ssl_server_name: ic."{{ domain_name }}"
      icecast2_ssl_upstream_name: icecast2

    - role: supervisord

    - role: wiki
      wiki_user: wiki
      wiki_path: /wiki
      wiki_port: 4567

    # disable dokku for now: dokku should be updated!
    # - role: dokku
    #   dokku_domain_name: d.{{ domain_name }}

    - role: lxc
      lxc_user: "{{ ansible_user_id }}"
      lxc_user_dir: "{{ ansible_user_dir }}"
      lxc_virbr_name: lxcbr0
      lxc_nic_num: 10
      lxc_subuid_start: 100000
      lxc_subuid_range: 65536
      lxc_subgid_start: 100000
      lxc_subgid_range: 65536

    - role: docker
      docker_compose_path: ./docker-compose
      docker_compose_env:
        # minio:
        #   MINIO_ACCESS_KEY: "10srr"
        #   MINIO_SECRET_KEY: "{{ minio_secret_key }}"
        nextcloud:
          MYSQL_USER: nextcloud
          MYSQL_ROOT_PASSWORD: "{{ nextcloud_mysql_root_password }}"
          MYSQL_DATABASE: nextcloud
          MYSQL_PASSWORD: "{{ nextcloud_mysql_password }}"
        10sr_bot:
          TWITTER_KEY: VmHRoeyCxmGisuGPCBADVfo6v
          TWITTER_SECRET: "{{ bot_twitter_secret }}"
          TWITTER_TOKEN: 2578716006-LhQWcRQyG5r0uC92yLwy1LYhNIPGMVXAy4CWOpt
          TWITTER_TOKEN_SECRET: "{{ bot_twitter_token_secret }}"

    - role: postfix
